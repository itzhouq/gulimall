## 商品上架

前台用户检索到的商品数据都是保存在 ES 中的，只有处于上架状态的是商品才能被检索到。

商品数据从数据库保存到 ES 中的过程称为**商品上架**。

在后台管理系统中，商品维护 - spu管理 - 上架，发送上架请求，修改上架状态。



### 0、为什么要将商品数据保存在 ES 中？

为了给用户更好地提供商品检索服务，检索的速度要快。ES 对全文检索功能的支持比 MySQL 强大。ES 数据存在于内存中，性能好。而且 ES 天然支持分布式，方便容量扩展。



### 1、sku 在 ES 中存储模型分析

- 我们只保存页面有用的数据到 ES
- 考虑哪些数据进 ES：sku 基本信息、分类信息、品牌信息、商品规格【spu信息】

#### 商品 Mapping

分析：商品上架在 ES 中是存 sku 还是 spu ？ 

1、检索的时候输入名字，是需要按照 sku 的 title 进行全文检索的。

2、检索使用商品规格，规格是 spu 的公共属性，每个 spu 是一样的。

3、按照分类 id 进去的都是直接都列出 spu 的，还可以切换。

4、我们如果将 sku 的全量信息都保存到 es 中（包括 spu 属性）就太多量字段了。

5、我们如果将 spu 以及他包含的的 sku 信息保存到 es 中，也可以方便检索。但是 sku 数据 spu 的级联对象，在 es 中需要 nested 模型，这行性能差点。

6、但是存储和检索我们必须西性能折中。

7、如果我们拆分存储，spu 和 attr 一个索引，sku 单独一个索引可能涉及的问题。检索商品的名字，如“手机”，对应的 spu 有很多，我们要分析出这些 spu 的所有关联属性，再做一次查询，就必须将所有 spu_id 都发出去。假设有 1 万个数据，数据传输一次就 10000 * 4 = 4MB；并发情况下假设 1000 检索请求，那就是 4GB 的数据，传输阻塞时间会很长，业务更加无法继续。所以，我们如下设计，这样才是文档区别于关系型数据的地方，宽表设计，不能考虑数据库范式。

```shell

```


